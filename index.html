<!DOCTYPE html>
<html>
  <style>
#loading {
  width: 100%;
  background-color: #ddd;
}

#bar {
  width: 0%;
  height: 30px;
  background-color: #04AA6D;
  text-align: center;
  line-height: 30px;
  color: white;
}
  </style>
  <body style="background: black;" onload="init()">
	<button style = "background-color: #f00; color: #0ff;" onclick="reset()">RESET</button> 
    <button style = "background-color: #0f0; color: #f0f;" onclick="start_tape()">START</button>
	<button style = "background-color: #f00; color: #0ff;" onclick="stop_tape()">STOP</button>
	<button style = "background-color: #000; color: #fff;" onclick="pause_tape()">PAUSE</button>
	<button style = "background-color: #00f; color: #ff0;" onclick="skip_step()">SKIP</button>
    <form style="display: inline-block;">
      <select id="tape_to_use" onChange="tape_to_use_cb()">
        <option value="-1">none</option>
      </select>
    </form>
    <form style="display: inline-block;">
      <div id="flags_form"></div>
    </form>
    <div id="loading">
      <div id="bar">0%</div>
    </div>
    
    <img id="board" src="https://i.imgur.com/cliDn19.jpeg" style="float: left; display: block; margin: auto; height: 876px; max-width: 100%; max-height: 100%; width: 100%">
  </body>
  
  <script>
// constants
const AC_END = 0;
const AC_RENDER = 1;
const AC_WAIT = 2;
const AC_RESET = 3;
const TIMER_DELTA = 10; // ms

// tape
var tape_EMPTY = [
{"action": AC_RENDER, "img": "https://i.imgur.com/D57b1Uv.jpeg"},
{"action": AC_END},
{"action": AC_END}
];
var tape_M4S_OT = [
{"action": AC_WAIT, time: 5000}, // countdown 19:37 -> 19:42
{"action": AC_RENDER, "img": "./img/m4s/nearfar1_OT.png"},
{"action": AC_WAIT, time: 57000}, // 19:42 -> 20:39
{"action": AC_RENDER, "img": "./img/m4s/nearfar2_tank.png"},
{"action": AC_WAIT, time: 36000}, // 20:39 -> 21:15
{"action": AC_RENDER, "img": "./img/m4s/ee1_OT.png"},
{"action": AC_WAIT, time: 47000}, // 21:15 -> 22:02
{"action": AC_RENDER, "img": "./img/m4s/ee2.png"},
{"action": AC_WAIT, time: 40000}, // 22:02 -> 22:42
{"action": AC_RENDER, "img": "./img/m4s/side_OT.png"},
{"action": AC_WAIT, time: 13000}, // 22:42 -> 22:55
{"action": AC_RENDER, "img": "./img/m4s/ee22.png"},
{"action": AC_WAIT, time: 24000}, // 22:42 -> 23:06
// TODO: rotate DN
{"action": AC_RENDER, "img": "./img/m4s/dn.png"},
{"action": AC_WAIT, time: 79000}, // 23:06 -> 24:25
{"action": AC_RENDER, "img": "./img/common/tankbuster_swap_OT.png"},
{"action": AC_WAIT, time: 10000}, // 24:25 -> 24:35
// TODO: last phase of p1
{"action": AC_RENDER, "img": "https://i.imgur.com/D57b1Uv.jpeg"},
{"action": AC_END},
{"action": AC_END}
];
var tape_M4S_MT = [
{"action": AC_WAIT, time: 5000}, // countdown 19:37 -> 19:42
{"action": AC_RENDER, "img": "./img/m4s/nearfar1_MT.png"},
{"action": AC_WAIT, time: 57000}, // 19:42 -> 20:39
{"action": AC_RENDER, "img": "./img/m4s/nearfar2_tank.png"},
{"action": AC_WAIT, time: 36000}, // 20:39 -> 21:15
{"action": AC_RENDER, "img": "./img/m4s/ee1_MT.png"},
{"action": AC_WAIT, time: 47000}, // 21:15 -> 22:02
{"action": AC_RENDER, "img": "./img/m4s/ee2.png"},
{"action": AC_WAIT, time: 40000}, // 22:02 -> 22:42
{"action": AC_RENDER, "img": "./img/m4s/side_MT.png"},
{"action": AC_WAIT, time: 13000}, // 22:42 -> 22:55
{"action": AC_RENDER, "img": "./img/m4s/ee22.png"},
{"action": AC_WAIT, time: 24000}, // 22:42 -> 23:06
// TODO: rotate DN
{"action": AC_RENDER, "img": "./img/m4s/dn.png"},
{"action": AC_WAIT, time: 77000}, // 23:06 -> 24:23
{"action": AC_RENDER, "img": "./img/common/tankbuster_swap_MT.png"},
{"action": AC_WAIT, time: 12000}, // 24:23 -> 24:35
// TODO: last phase of p1
{"action": AC_RENDER, "img": "https://i.imgur.com/D57b1Uv.jpeg"},
{"action": AC_END},
{"action": AC_END}
];
var tape_M4S_OT_ADV = [
{"action": AC_WAIT, time: 5000}, // countdown 17:54 -> 17:59
//{"action": AC_RENDER, "img": "./img/m4s/nearfar1_OT.png"},
{"action": AC_RENDER, "img": "./img/m4s/nearfar2_tank.png"},
{"action": AC_WAIT, time: 93000}, // 17:59 -> 19:32
{"action": AC_RENDER, "img": "./img/m4s/ee1_OT.png"},
{"action": AC_WAIT, time: 47000}, // 19:32 -> 20:19
{"action": AC_RENDER, "img": "./img/m4s/ee2.png"},
{"action": AC_WAIT, time: 40000}, // 20:19 -> 20:59
{"action": AC_RENDER, "img": "./img/m4s/side_OT.png"},
{"action": AC_WAIT, time: 13000}, // 20:59 -> 21:12
{"action": AC_RENDER, "img": "./img/m4s/ee22.png"},
{"action": AC_WAIT, time: 24000}, // 21:12 -> 21:36
{"action": AC_RENDER, "img": "./img/m4s/dn.png"},
{"action": AC_WAIT, time: 174000}, // 21:36  -> 24:30
// p2 start
{"action": AC_RENDER, "img": "./img/m4s/LB_move_right.png"},
{"action": AC_WAIT, time: 40000}, // 24:30  -> 25:10
{"action": AC_RENDER, "img": "./img/m4s/look_boss_mustard.png"},
{"action": AC_WAIT, time: 60000}, // 25:10  -> 26:10
{"action": AC_RENDER, "img": "./img/m4s/twilight.png"},
{"action": AC_WAIT, time: 40000}, // 26:10  -> 26:50
{"action": AC_RENDER, "img": "./img/m4s/midnight.png"},
{"action": AC_WAIT, time: 37000}, // 26:50  -> 27:27
{"action": AC_RENDER, "img": "./img/m4s/swords.png"},
{"action": AC_WAIT, time: 63000}, // 27:27  -> 28:30
{"action": AC_RENDER, "img": "./img/m4s/look_boss_mustard.png"},
{"action": AC_WAIT, time: 35000}, // 28:30  -> 29:05
{"action": AC_RENDER, "img": "./img/m4s/sunrise_normal.png"},
{"action": AC_WAIT, time: 90000}, // 28:30  -> 30:00?
{"action": AC_RENDER, "img": "./img/m4s/enrage.png"},
{"action": AC_WAIT, time: 90000}, // 30:00? -> ???
// TODO: last phase of p1
{"action": AC_RENDER, "img": "https://i.imgur.com/D57b1Uv.jpeg"},
{"action": AC_END},
{"action": AC_END}
];
var tape_M4S_MT_ADV = [
{"action": AC_WAIT, time: 5000}, // countdown 17:54 -> 17:59
//{"action": AC_RENDER, "img": "./img/m4s/nearfar1_OT.png"},
{"action": AC_RENDER, "img": "./img/m4s/nearfar2_tank.png"},
{"action": AC_WAIT, time: 93000}, // 17:59 -> 19:32
{"action": AC_RENDER, "img": "./img/m4s/ee1_MT.png"},
{"action": AC_WAIT, time: 47000}, // 19:32 -> 20:19
{"action": AC_RENDER, "img": "./img/m4s/ee2.png"},
{"action": AC_WAIT, time: 40000}, // 20:19 -> 20:59
{"action": AC_RENDER, "img": "./img/m4s/side_MT.png"},
{"action": AC_WAIT, time: 13000}, // 20:59 -> 21:12
{"action": AC_RENDER, "img": "./img/m4s/ee22.png"},
{"action": AC_WAIT, time: 24000}, // 21:12 -> 21:36
{"action": AC_RENDER, "img": "./img/m4s/dn.png"},
{"action": AC_WAIT, time: 174000}, // 21:36  -> 24:30
// p2 start
{"action": AC_RENDER, "img": "./img/m4s/LB_move_right.png"},
{"action": AC_WAIT, time: 40000}, // 24:30  -> 25:10
{"action": AC_RENDER, "img": "./img/m4s/look_boss_mustard.png"},
{"action": AC_WAIT, time: 60000}, // 25:10  -> 26:10
{"action": AC_RENDER, "img": "./img/m4s/twilight.png"},
{"action": AC_WAIT, time: 40000}, // 26:10  -> 26:50
{"action": AC_RENDER, "img": "./img/m4s/midnight.png"},
{"action": AC_WAIT, time: 37000}, // 26:50  -> 27:27
{"action": AC_RENDER, "img": "./img/m4s/swords.png"},
{"action": AC_WAIT, time: 63000}, // 27:27  -> 28:30
{"action": AC_RENDER, "img": "./img/m4s/look_boss_mustard.png"},
{"action": AC_WAIT, time: 35000}, // 28:30  -> 29:05
{"action": AC_RENDER, "img": "./img/m4s/sunrise_normal.png"},
{"action": AC_WAIT, time: 90000}, // 28:30  -> 30:00?
{"action": AC_RENDER, "img": "./img/m4s/enrage.png"},
{"action": AC_WAIT, time: 90000}, // 30:00? -> ???
// TODO: last phase of p1
{"action": AC_RENDER, "img": "https://i.imgur.com/D57b1Uv.jpeg"},
{"action": AC_END},
{"action": AC_END}
];
var flags_EX1_TEST = [
  {"name": "phase", "values": ["Fire", "Ice", "Lightning"], "default": "Fire"},
  {"name": "TEST", "values": ["Test1", "Test2"], "default": "Test1"}
];
var tape_EX1_TEST = [
{"action": AC_WAIT, time: 5000},
{"action": AC_RENDER, "img": "https://i.imgur.com/Y1FQH4V.png"},
{"action": AC_WAIT, time: 15000},
{"action": AC_RENDER, "img": "https://i.imgur.com/wMKE14s.jpeg", "cond": {"flag": "phase", "value": "Fire"}},
{"action": AC_RENDER, "img": "https://i.imgur.com/ij9GR7Q.jpeg", "cond": {"flag": "phase", "value": "Ice"}},
{"action": AC_RENDER, "img": "https://i.imgur.com/K0BNeSw.jpeg", "cond": {"flag": "phase", "value": "Lightning"}},
{"action": AC_WAIT, time: 15000},
{"action": AC_RENDER, "img": "https://i.imgur.com/wMKE14s.jpeg", "cond": {"flag": "phase", "value": "Fire"}},
{"action": AC_RENDER, "img": "https://i.imgur.com/ij9GR7Q.jpeg", "cond": {"flag": "phase", "value": "Ice"}},
{"action": AC_RENDER, "img": "https://i.imgur.com/K0BNeSw.jpeg", "cond": {"flag": "phase", "value": "Lightning"}},
{"action": AC_WAIT, time: 15000},
{"action": AC_RENDER, "img": "https://i.imgur.com/wMKE14s.jpeg", "cond": {"flag": "phase", "value": "Fire"}},
{"action": AC_RENDER, "img": "https://i.imgur.com/ij9GR7Q.jpeg", "cond": {"flag": "phase", "value": "Ice"}},
{"action": AC_RENDER, "img": "https://i.imgur.com/K0BNeSw.jpeg", "cond": {"flag": "phase", "value": "Lightning"}},
{"action": AC_WAIT, time: 15000},
{"action": AC_RENDER, "img": "https://i.imgur.com/wMKE14s.jpeg", "cond": {"flag": "phase", "value": "Fire"}},
{"action": AC_RENDER, "img": "https://i.imgur.com/ij9GR7Q.jpeg", "cond": {"flag": "phase", "value": "Ice"}},
{"action": AC_RENDER, "img": "https://i.imgur.com/K0BNeSw.jpeg", "cond": {"flag": "phase", "value": "Lightning"}},
{"action": AC_WAIT, time: 47000},
{"action": AC_END},
{"action": AC_END}
]

// flag storage module
var flag_data = {}

function flag_init() {
  flag_data = { list: [], values: {}, defval: {}};
}
function flag_reset() {
  flag_data.list.forEach(e => { 
	flag_data.values[e] = flag_data.defval[e];
  });
}
function flag_configure(flag_config) {
  flag_init()
  if(flag_config) {
    flag_config.forEach(e => { 
      flag_data.list.push(e.name);
      flag_data.defval[e.name] = e.default
	})
  }
  flag_reset();
}
function flag_set(flag_name, flag_value) {
  flag_data.values[flag_name] = flag_value;
}
function flag_get(flag_name) {
  return flag_data.values[flag_name];
}

var tapes = [];
function init_tapes() {
  if(tapes.length == 0)
  {
    tapes[0] = {name: "M4S OT", tape: tape_M4S_OT};
    tapes[1] = {name: "M4S MT", tape: tape_M4S_MT};
    tapes[2] = {name: "M4S OT ADV", tape: tape_M4S_OT_ADV};
    tapes[3] = {name: "M4S MT ADV", tape: tape_M4S_MT_ADV};
    tapes[4] = {name: "Valigarmanda", tape: tape_EX1_TEST, flags: flags_EX1_TEST};
    var select = document.getElementById("tape_to_use");
    for(var i = 0; i < tapes.length; i++)
    {
      var option = document.createElement('option');
      option.text = tapes[i].name;
      option.value = i;
      select.add(option, 0);
    }
  }
}
var tape = tape_EMPTY;
function tape_select(i) {
  reset();
  if(i == -1)
  {
    console.log("using empty tape");
    tape = tape_EMPTY;
  }
  else
  {
    console.log("using tape " + i + " name [" + tapes[i].name + "]");
    tape = tapes[i].tape;
    flag_configure(tapes[i].flags);
    create_flag_dropdowns(tapes[i])
  }
}

function tape_to_use_cb() {
  let select = document.getElementById("tape_to_use");
  tape_select(select.value);
}

function flag_dropdown_cb(flag_name){
  let select = document.getElementById("flag_dropdown_id_" + flag_name);
  flag_set(flag_name, select[select.value].text);
}

var flags = []

function create_flag_dropdowns(tape) {
  clear_flag_dropdowns();
  if (tape?.flags === undefined) {
    console.log("using empty flags");
    flags = [];
  }
  else {
    console.log("using flags for " + tape.name);
    flags = tape.flags;
    set_flag_dropdowns(flags);
  }
}

function clear_flag_dropdowns() {
  let form = document.getElementById("flags_form");
  while (form.firstChild) {
    form.removeChild(form.firstChild);
  }
}

function set_flag_dropdowns(flags) {
  let dropdowns = document.getElementById("flags_form");
  for(var i = 0; i < flags.length; i++) {
    let dropdownName = document.createElement("span");
    dropdownName.innerHTML += (flags[i].name);
    dropdownName.style.color = "#0f0";
    dropdowns.appendChild(dropdownName);

    var select = document.createElement('select');
    select.onchange = flag_dropdown_cb.bind(null, flags[i].name); //"flag_dropdown_cb(\"" + flags[i].name + "\")"
    select.id = "flag_dropdown_id_" + flags[i].name;
    for (var j = 0; j < flags[i].values.length; j++) {
      var option = document.createElement('option');
      option.text = flags[i].values[j];
      option.value = j;
      select.add(option, j);
    }
    dropdowns.appendChild(select);
  }
}

// bar controller
var bar = document.getElementById("bar");
function bar_set(percentage) {
  p = Math.floor(percentage);
  bar.style.width = p + "%";
  bar.innerHTML = p + "%";
}

function reset() {
  document.getElementById('board').src = "https://i.imgur.com/cliDn19.jpeg";
  active_tape = 0;
  step_skipped = false;
  tape_paused = false;
  bar_set(0);
  flag_reset();
}

function init() {
  init_tapes();
  flag_init();
  reset();
}

// tape manipulator
var step_skipped = false;
var tape_paused = false;
var active_tape = 0;

function cond_check(snapshot) {
  var condition = snapshot.cond;
  if(condition)
  {
    // we have a condition
    flag_value = flag_get(condition.flag);
    flag_desired_value = condition.value;
    return flag_value == flag_desired_value;
  }
  // if no condition is set, always pass conditional
  return true;
}

function move_tape(current_tape, tape_index, last_now, delta) {
  if(current_tape != active_tape) {
    return; // tape was stopped
  }
  var NOW = Date.now();
  var snapshot = tape[tape_index];
  switch(snapshot.action) {
    case AC_END:
	  active_tape = 0;
	  console.error("OK");
	  return;
	case AC_RENDER:
	  if(cond_check(snapshot))
	  {
	    document.getElementById('board').src = snapshot.img;
	  }
	  break;
	case AC_WAIT:
	  if(step_skipped) {
	    delta = snapshot.time + 1;
	  }
	  else {
	    if(!tape_paused) {
	      delta = delta + NOW - last_now;
		}
	  }
	  step_skipped = false;
	  bar_set((delta * 100) / snapshot.time);
	  if(delta <= snapshot.time) {
	    setTimeout(move_tape, TIMER_DELTA, current_tape, tape_index, NOW, delta);
	    return;
	  }
	  break;
	case AC_RESET:
	  reset();
	  break;
	default:
	  console.error("unrecognised action ", snapshot.action);
	  return;
  }
  move_tape(current_tape, tape_index + 1, NOW, 0);
}

var last_tape_id = 0;
function start_tape () {
  reset();
  last_tape_id = last_tape_id + 1;
  active_tape = last_tape_id;
  move_tape(last_tape_id, 0, Date.now(), 0);
};
function stop_tape () {
  active_tape = 0;
}
function skip_step () {
  step_skipped = true;
}

function pause_tape () {
  tape_paused = !tape_paused;
}
</script>
</html>
